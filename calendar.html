<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Real Meeter - baza danych interakcji społecznych</title>
        <link rel="stylesheet" href="styles.css">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
        <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">
    </head>
    <body>
        <header>
            Baza danych spotkań
        </header>
        <div class="container">

            <div id="day_modal">
                <div id="topOfDayModal">
                    <div id="closingDiv" onclick="closeModal()">X</div>
                </div>
                <div id="restOfModal">
                    <div id="leftModalMenu">

                    </div>
                    <div id="modalInfo">

                    </div>
                </div>
            </div>


            <nav class="left-menu">
            </nav>
            <div id="main">

            </div>
            <aside class="right-menu">
                <!-- Right menu content goes here -->
            </aside>
        </div>
    </body>
    <script src="createLeftMenu.js" ></script>
    <script>
        function createInteractingPersonObj(humanName, photoDir) {
            let modalInfo = document.getElementById("placeForInteractingPeople")

            let createdElement = document.createElement("img")
            createdElement.setAttribute("title", humanName)
            createdElement.setAttribute("src", photoDir)
            createdElement.setAttribute("class", "interactingPersonImage")

            modalInfo.appendChild(createdElement)            
        }

        function clearModalInfo() {
            document.getElementById("modalInfo").innerHTML = ""
        }
        async function showGeneralInfo(humanId) {
            clearModalInfo()
            const basicHumanInfoReq = await fetch(`http://localhost:3000/basic-info-for-human-modal?humanId=${humanId}`)
            const basicInfoJson = await basicHumanInfoReq.json()
            let modalInfo = document.getElementById("modalInfo")

            let humanPhotoElement = document.createElement("img")
            humanPhotoElement.setAttribute("src", basicInfoJson["photoDir"])
            humanPhotoElement.setAttribute("class", "humanPhotoInModal")
            modalInfo.appendChild(humanPhotoElement)

            let humanNameElement = document.createElement("div")
            humanNameElement.innerText = basicInfoJson["fullName"]
            humanNameElement.setAttribute("class", "nameInGeneralInfo")
            modalInfo.appendChild(humanNameElement)

            if (basicInfoJson["superpowers"] && basicInfoJson["superpowers"].length > 0) {
                let superpowersDiv = document.createElement("div")
                superpowersDiv.id = "superpowersDiv"
                modalInfo.appendChild(superpowersDiv)

                for (let superpower of basicInfoJson["superpowers"]) {
                    let singleSuperpower = document.createElement("img")
                    singleSuperpower.className = "singleSuperpower"
                    singleSuperpower.setAttribute("src", superpower.photo)
                    singleSuperpower.setAttribute("title", superpower.name)
                    superpowersDiv.appendChild(singleSuperpower)
                }
            }


            let cliqueLine = document.createElement("div")
            cliqueLine.innerText = `Należy do kliki ${basicInfoJson["cliqueName"]}.`
            cliqueLine.setAttribute("class", "lineInGeneralInfo")
            modalInfo.appendChild(cliqueLine)

            let visitsLine = document.createElement("div")
            visitsLine.innerText = `Liczba wizyt: ${basicInfoJson["visitsCount"]}.`
            visitsLine.setAttribute("class", "lineInGeneralInfo")
            modalInfo.appendChild(visitsLine)

            let meetingsLine = document.createElement("div")
            meetingsLine.innerText = `Liczba spotkań: ${basicInfoJson["meetingsCount"]}.`
            meetingsLine.setAttribute("class", "lineInGeneralInfo")
            modalInfo.appendChild(meetingsLine)

            let eventsLine = document.createElement("div")
            eventsLine.innerText = `Liczba wspónych wydarzeń: ${basicInfoJson["eventsCount"]}.`
            eventsLine.setAttribute("class", "lineInGeneralInfo")
            modalInfo.appendChild(eventsLine)

            let quotesLine = document.createElement("div")
            quotesLine.setAttribute("class", "lineInGeneralInfo")
            basicInfoJson["gender"] == "M" ? quotesLine.innerText = `Autor ${basicInfoJson["quotesCount"]} publicznych cytatów.` : 
            quotesLine.innerHTML = `Autorka ${basicInfoJson["quotesCount"]} publicznych cytatów.`
            modalInfo.appendChild(quotesLine)

            if (basicInfoJson["spouse_name"] != null) {
                let spouseLine = document.createElement("div")
                spouseLine.setAttribute("class", "lineInGeneralInfo")
                basicInfoJson["gender"] == "M" ? spouseLine.innerText = `Jego żoną jest ${basicInfoJson["spouse_name"]}.` : spouseLine.innerText = `Jej mężem jest ${basicInfoJson["spouse_name"]}.`
                modalInfo.appendChild(spouseLine)
            }

            

            let lastSeenDiv = document.createElement("div")
            lastSeenDiv.innerText = basicInfoJson["lastSeen"]
            lastSeenDiv.setAttribute("class", "lineInGeneralInfo")
            modalInfo.appendChild(lastSeenDiv)


            if (basicInfoJson["interactionPlacesCategories"].length > 0) {
                let placeForTableDiv = document.createElement("div")
                placeForTableDiv.setAttribute("id", "placeForTableDiv")
                modalInfo.appendChild(placeForTableDiv)

                let placesCategoriesHeader = document.createElement("h3")
                placesCategoriesHeader.innerText = "Gdzie się spotykacie poza tripami?"
                placeForTableDiv.appendChild(placesCategoriesHeader)

                let interactionPlacesTable = document.createElement("table")
                interactionPlacesTable.innerHTML = `
                <tr> 
                    <th>Kategoria miejsca</th> 
                    <th> Liczba interakcji</th>
                </tr>
                `
                const placesInfo = basicInfoJson["interactionPlacesCategories"]
                for (let category of placesInfo) {
                    let row = interactionPlacesTable.insertRow(-1)
                    let categoryCell = row.insertCell(0)
                    categoryCell.innerHTML = category["category"]
                    let countCell = row.insertCell(1)
                    countCell.innerHTML = category["category_count"]
                }
                placeForTableDiv.appendChild(interactionPlacesTable)

            }

            



            const usualCompanionsReq = await fetch(`http://localhost:3000/get-often-seen-with?humanId=${humanId}`)
            const usualCompanionsJson = await usualCompanionsReq.json()

            if (usualCompanionsJson.length > 0) {
                let closeFriendsHeader = document.createElement("h3")
                basicInfoJson["gender"] == "M" ? closeFriendsHeader.innerText = "Widywany z:" : closeFriendsHeader.innerText = "Widywana z:"
                modalInfo.appendChild(closeFriendsHeader)

                let placeForInteractingPeople = document.createElement("div")
                placeForInteractingPeople.id = "placeForInteractingPeople"
                modalInfo.appendChild(placeForInteractingPeople)

                for (let human of usualCompanionsJson) {
                    createInteractingPersonObj(human.fullName, human.photoDir)
                }
            }

        }
        function makeCalendar(year) {
            const startDay = new Date(`${year}-01-01`)
            const lastDay = new Date(`${year}-12-31`)
            let daysCounter = 0
            const monthJson = {0: "Styczeń", 1:"Luty", 2: "Marzec", 3: "Kwiecień", 4: "Maj", 5: "Czerwiec", 6:"Lipiec", 7: "Sierpień", 8:"Wrzesień", 9:"Październik", 10: "Listopad", 11:"Grudzień"}
            const weekdaysArray = ["Poniedziałek", "Wtorek", "Środa", "Czwartek", "Piątek", "Sobota", "Niedziela"]
            const trimDays = weekdaysArray.map((nameOfWeek) => nameOfWeek.substring(0,3) + ".")
            let main_content = document.getElementById("main")
            let containerForCalendar = document.createElement("div")
            containerForCalendar.setAttribute("class", "calendarContainer")
            main_content.appendChild(containerForCalendar)
            for (let day = startDay; day <= lastDay; day.setDate(day.getDate() + 1)) {
                let addedDayRectangle = document.createElement("div")
                addedDayRectangle.setAttribute("class", "dayRectangle")
                const dayOfMonth = day.getDate().toString()
                if (dayOfMonth == 1) {
                    let numberOfGhostDays = 6
                    containerForCalendar.innerHTML += `<h2>${monthJson[day.getMonth()]} ${day.getFullYear()}</h2>`
                    for (const name of trimDays) {
                        let nameOfWeekdayDiv = document.createElement("div")
                        nameOfWeekdayDiv.setAttribute("class", "nameOfWeekdayDiv")
                        nameOfWeekdayDiv.innerHTML = name
                        containerForCalendar.appendChild(nameOfWeekdayDiv)
                    }
                    const dayOfWeek = day.getDay()
                    if (dayOfWeek != 0) {
                        numberOfGhostDays = dayOfWeek - 1
                    }
                    for (let i = 0; i < numberOfGhostDays; i++) {
                        let ghostDayToAdd = document.createElement("div")
                        ghostDayToAdd.setAttribute("class", "ghostDayRectangle")
                        containerForCalendar.appendChild(ghostDayToAdd)
                    }
                }
                const startOfMonth = monthJson[day.getMonth()].substring(0, 3)
                let thing_to_write = `${dayOfMonth} ${startOfMonth}`
                let date_id = `${dayOfMonth}_${startOfMonth}_${day.getFullYear()}`
                addedDayRectangle.innerHTML = thing_to_write
                addedDayRectangle.setAttribute("onclick", `showDayModal("${day}")`)
                addedDayRectangle.setAttribute("id", date_id)
                containerForCalendar.appendChild(addedDayRectangle)
            }
            addThingsToCalendar(year)
        }
        async function showDayModal(date) {
            let dateAsDate = new Date(date)
            let modalElement = document.getElementById("day_modal")
            modalElement.style.display = "block"
            const dateString = `${dateAsDate.getFullYear()}-${dateAsDate.getMonth() + 1}-${dateAsDate.getDate()}`
            const dayReq = await fetch(`http://localhost:3000/basic-day-info?dateString=${dateString}`)
            let dayJson = await dayReq.json()
            console.log(dayJson)
            let leftModalMenu = document.getElementById("leftModalMenu")
            let dayDescButton = document.createElement("div")
            dayDescButton.id = "dayDescButton"
            dayDescButton.innerText = "Opis dnia"
            leftModalMenu.appendChild(dayDescButton)
            for (let record of dayJson) {
                if (!leftModalMenu.innerText.includes(record.humanName)) {
                    let humanButton = document.createElement("div")
                    humanButton.innerText = record["humanName"]
                    humanButton.setAttribute("class", "left_modal_option")
                    humanButton.setAttribute("onclick", `showGeneralInfo(${record.humanId})`)
                    leftModalMenu.appendChild(humanButton)
                }
            }
            printInteractionsInfoFromDayJson(dayJson)
        }
        function printInteractionsInfoFromDayJson(dayJson) {
            let interactionsDict = {}
            for (let interaction of dayJson) {
                if (!(interaction.title in interactionsDict)) {
                    interactionsDict[interaction.title] = {"long_desc": interaction.long_desc, "humans": [{"name": interaction.name}]}
                }
            }
        }
        function createSlider(modifiedDivId, array_of_photos, divColor) {
            let modifiedDiv = document.getElementById(modifiedDivId)
            let sliderDiv = document.createElement("div")
            sliderDiv.setAttribute("class", "slider")
            modifiedDiv.appendChild(sliderDiv)
            modifiedDiv.setAttribute("style", `background-color: ${divColor}`)
            let imageElement = document.createElement("img")
            let firstPhoto = array_of_photos[0]
            imageElement.setAttribute("src", firstPhoto)
            sliderDiv.appendChild(imageElement)
            function photoSlider() {
                        let index = 0
                        function newImage() {
                            imageElement.setAttribute("src", array_of_photos[index])
                            index = (index + 1) % array_of_photos.length
                            sliderDiv.appendChild(imageElement)
                        }
                        setInterval(newImage,2000)
                    }
                    photoSlider()

        }
        async function addThingsToCalendar(year) {
            let allClasses = []
            const yearEvents = await fetch(`http://localhost:3000/get-calendar?year=${year}`)
            const yearJson = await yearEvents.json()
            const ringsPhotoDir = "backend\\functionalPhotos\\rings.png"
            for (let [dateId, activity] of Object.entries(yearJson)) {
                if (!(allClasses.includes(activity["interactionClass"]))) {
                    allClasses.push(activity["interactionClass"])
                }
                let modifiedDiv = document.getElementById(dateId)
                modifiedDiv.innerHTML = ""
                if (activity["interactionClass"].includes("trip")) {
                    createSlider(dateId, activity["photos"], "#f5f527")
                }
                else if (activity["interactionClass"] == "visit") {
                    createSlider(dateId, activity["photos"], "red")
                }
                else if (activity["interactionClass"] == "meeting") {
                    createSlider(dateId, activity["photos"], "blue")
                }
                else if (activity["interactionClass"] == "event") {
                    createSlider(dateId, activity["photos"], "green")
                }
                else if (activity["interactionClass"] == "visit_meeting") {
                    createSlider(dateId, activity["photos"], "#ff8000")
                }
                else if (activity["interactionClass"] == "visit_event") {
                    createSlider(dateId, activity["photos"], "#cc00cc")
                }
                else if (activity["interactionClass"] == "meeting_event") {
                    createSlider(dateId, activity["photos"], "#00cccc")
                }
                else if (activity["interactionClass"].includes("trip")) {
                    createSlider(dateId, activity["photos"], "#f5f527")
                }
                else if (activity["interactionClass"] == "wedding") {
                    modifiedDiv.setAttribute("style", "background-color: #ff72fb")
                    if (!activity.hasOwnProperty("partnerPhoto")) {
                        console.log("Mamy tutaj wesele bez partnerki.")
                        modifiedDiv.className += " weddingWoParther"

                        let groomPhotoElement = document.createElement("img")
                        groomPhotoElement.className = "groomPhoto" 
                        groomPhotoElement.setAttribute("src", activity.manPhoto)
                        modifiedDiv.appendChild(groomPhotoElement)

                        let ringsPhotoElement = document.createElement("img")
                        ringsPhotoElement.className = "ringsPhoto" 
                        ringsPhotoElement.setAttribute("src", ringsPhotoDir)
                        modifiedDiv.appendChild(ringsPhotoElement)

                        let bridePhotoElement = document.createElement("img")
                        bridePhotoElement.className = "bridePhoto" 
                        bridePhotoElement.setAttribute("src", activity.womanPhoto)
                        modifiedDiv.appendChild(bridePhotoElement)


                    }
                    else {
                        console.log("Wesele z partnerką!")
                        modifiedDiv.className += " weddingWithParther"

                        let groomPhotoElement = document.createElement("img")
                        groomPhotoElement.className = "groomPhoto" 
                        groomPhotoElement.setAttribute("src", activity.manPhoto)
                        modifiedDiv.appendChild(groomPhotoElement)

                        let ringsPhotoElement = document.createElement("img")
                        ringsPhotoElement.className = "ringsPhoto" 
                        ringsPhotoElement.setAttribute("src", ringsPhotoDir)
                        modifiedDiv.appendChild(ringsPhotoElement)
                        
                        let bridePhotoElement = document.createElement("img")
                        bridePhotoElement.className = "bridePhoto" 
                        bridePhotoElement.setAttribute("src", activity.womanPhoto)
                        modifiedDiv.appendChild(bridePhotoElement)


                        let partnerPhotoElement = document.createElement("img")
                        partnerPhotoElement.className = "partnerPhoto" 
                        partnerPhotoElement.setAttribute("src", activity.partnerPhoto)
                        modifiedDiv.appendChild(partnerPhotoElement)
                    }
                }
                modifiedDiv.setAttribute("title", activity["computedTitle"])
                }

        }
        function closeModal() {
            let dayInfoElement = document.getElementById("modalInfo")
            let modalElement = document.getElementById("day_modal")
            let leftModalMenu = document.getElementById("leftModalMenu")
            leftModalMenu.innerHTML = ""
            dayInfoElement.innerHTML = ""
            modalElement.style.display = "none"
        }
        createLeftMenu()
        makeCalendar(2025)
    </script>
</html>
